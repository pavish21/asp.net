
CREATE PROCEDURE [dbo].[csp_GetVoucherMaintenanceList]	
	@PageIndex INT,
	@PageSize INT,
	@Sortexpression NVARCHAR(MAX) = NULL,
	@WhereClause NVARCHAR(MAX),
	@TotalRecords INT OUTPUT,
	@FilterId INT,
	@masterDb VARCHAR(50) 	
AS
BEGIN
	DECLARE @FirstRec INT
	DECLARE @LastRec INT  
	DECLARE @Sql NVARCHAR(MAX)
	DECLARE @Query NVARCHAR(MAX)
	DECLARE @FilterClause NVARCHAR(MAX)
	DECLARE @TopSql INT
	DECLARE @OrderSql NVARCHAR(MAX)
	DECLARE @FilterQuery NVARCHAR(MAX)	

	CREATE TABLE #TEMP_FILTER
	(
		FilterClausetbl NVARCHAR(MAX),
		TopSqltbl INT,
		OrderSql NVARCHAR(MAX)	
	)		
	IF (@FilterId > 0)
		BEGIN			
			SELECT @FilterClause = F.FILTER_SQL, @TopSql =F.TOP_SQL, @OrderSql = F.ORDER_SQL FROM [Fin1234567_FA_Common].[dbo].FILTERS F LEFT JOIN [Fin1234567_FA_Common].[dbo].USERS U ON F.USERID = U.USERID WHERE F.FILTERID = @FilterId																
			SET @FilterQuery = N'INSERT INTO #TEMP_FILTER(FilterClausetbl) SELECT F.FILTER_SQL FROM '+ @masterDb +'.dbo.FILTERS F LEFT JOIN '+ @masterDb +'.dbo.USERS U ON F.USERID = U.USERID WHERE F.FILTERID = ' +  CAST(@FilterId AS NVARCHAR(50)) + ''			
			EXEC sp_executesql @FilterQuery			
									
			SELECT @FilterClause = FilterClausetbl ,@TopSql = TopSqltbl , @OrderSql = OrderSql FROM #TEMP_FILTER			
			DROP TABLE #TEMP_FILTER			
		END			

	IF @WhereClause = '' OR @WhereClause IS NULL
		BEGIN
			SET	@WhereClause = '1=1'
			IF (@FilterId > 0)
				BEGIN
					SET	@WhereClause = @FilterClause					
				END											
		END
	ELSE
		BEGIN
			IF (@FilterId > 0)
			BEGIN
			  SET @WhereClause = @FilterClause + ' AND ' + @WhereClause
			END
		END	
						
	IF @Sortexpression = '' OR @Sortexpression IS NULL
		BEGIN
			SET	@Sortexpression ='AVAIN DESC' 
		END

	SET @Query='SELECT @TotalRecords = COUNT(1) FROM KOMK1 WHERE ' + @WhereClause 
	EXEC sp_executesql @Query, N'@TotalRecords INT OUTPUT', @TotalRecords OUTPUT;

	IF @TopSql > 0 AND @TopSql <= @TotalRecords 
		BEGIN			
			SET @TotalRecords = @TopSql		
		END
 	
	IF @PageIndex = -1
		BEGIN
		   SET @FirstRec = 0 
		   SET @LastRec = @TotalRecords
		END 
	ELSE IF @PageSize > 0 		
		BEGIN
			SET @FirstRec = ( @PageIndex - 1 ) * @PageSize  
			SET @LastRec =  @PageSize 		

			IF (@FilterId > 0 )
				BEGIN
					--Check for the Max Records
					DECLARE @CurrentCount INT		  
					SET @CurrentCount = @FirstRec + @PageSize			
					IF(@CurrentCount > @TotalRecords)
						BEGIN						
							 SET @LastRec = @TotalRecords-@FirstRec					 
						END
				END
		END
	IF @LastRec = 0  
		BEGIN
			SET @LastRec =  1
		END

	IF(@LastRec<0)
		BEGIN
			SET @Sql='SELECT AVAIN, ESINENO, KOONTI1, TOSNO,TOSLAJI, HANKHE, KPPVM, HAKOODI, PAIKA,PAIKA2, PAIKA3, PKOODI, PKOODI2, PKOODI3,SMJPROS, SMJPROS2, 
			SMJPROS3, TILINO, KUSTNO,PROJRY, PROJNO, VAKNO, TOIMNO, SELITE1,EVL, EVLPKOODI, POISHE, HANKHI, HANKHI2,EVLALKUS, EVLPVM, MAXPOISTO, JAKSPOISTO,
			TILIVEVLP, EVLMENOJ, VAKARVO, JARVO,RAHOSUUS, SUMUPVM, KKSUMUP, TILIVSUMUP,KUMULSUMUP, SUMUMENOJ, ALKHANKHI, NIMIKENO,OMNO, KPL, AHINTA,
			CAST (0 AS BIT) AS RAJA1, VIENTIMEMO,KUVA, PAAKORTTI, ESINETYYPPI, MYYTOSNO,MYYHETKI, MYYHINTA, MYYKOODI, OSTAJA,TULOUTUS, MYYSELITE, 
			MYYVOITTO, LASKENTAAN,VIETY, CUR, CURKURSSI, CURPVM, PERUSTETTU,PERUSTAJA, MUUTETTU, MUUTTAJA, INVENTOITU,INVENTOIJA, INVKPL, ALKHANKHI2, 
			SIJATUN,TTULOSTETT, LUOVTYYP, INDEHANKHI, ALKUPERHI, KORKO,ONKOARVOM, ARVOTILINO, BUDKKPEL,ARVONALE,ARVALEIAS,ARVALETILV,ARVPALTILV,ARVALIASTV,
			ARVPAIASTV,PARENT_AVAIN, MYYTOSLAJI,JAKOHE,TOJAKSUHDE,AMJAKSUHDE,KEAKTVIETY,INVOICE_PK,SIIRPERO,SIIRSUMUP,SIIREVLALK FROM KOMK1 WHERE AVAIN=-1'
		END
	ELSE
		BEGIN
			SET @Sql='SELECT AVAIN, ESINENO, KOONTI1, TOSNO,TOSLAJI, HANKHE, KPPVM, HAKOODI, PAIKA,PAIKA2, PAIKA3, PKOODI, PKOODI2, PKOODI3,SMJPROS, SMJPROS2, 
			SMJPROS3, TILINO, KUSTNO,PROJRY, PROJNO, VAKNO, TOIMNO, SELITE1,EVL, EVLPKOODI, POISHE, HANKHI, HANKHI2,EVLALKUS, EVLPVM, MAXPOISTO, JAKSPOISTO,
			TILIVEVLP, EVLMENOJ, VAKARVO, JARVO,RAHOSUUS, SUMUPVM, KKSUMUP, TILIVSUMUP,KUMULSUMUP, SUMUMENOJ, ALKHANKHI, NIMIKENO,OMNO, KPL, AHINTA,
			CAST (0 AS BIT) AS RAJA1, VIENTIMEMO,KUVA, PAAKORTTI, ESINETYYPPI, MYYTOSNO,MYYHETKI, MYYHINTA, MYYKOODI, OSTAJA,TULOUTUS, MYYSELITE, 
			MYYVOITTO, LASKENTAAN,VIETY, CUR, CURKURSSI, CURPVM, PERUSTETTU,PERUSTAJA, MUUTETTU, MUUTTAJA, INVENTOITU,INVENTOIJA, INVKPL, ALKHANKHI2, 
			SIJATUN,TTULOSTETT, LUOVTYYP, INDEHANKHI, ALKUPERHI, KORKO,ONKOARVOM, ARVOTILINO, BUDKKPEL,ARVONALE,ARVALEIAS,ARVALETILV,ARVPALTILV,ARVALIASTV,
			ARVPAIASTV,PARENT_AVAIN, MYYTOSLAJI,JAKOHE,TOJAKSUHDE,AMJAKSUHDE,KEAKTVIETY,INVOICE_PK,SIIRPERO,SIIRSUMUP,SIIREVLALK FROM KOMK1 
			WHERE ' + @WhereClause + ' ORDER BY '
			SET @Sql=@Sql + @SortExpression +
			' OFFSET ' + CAST(@FirstRec AS NVARCHAR(10)) +
			' ROWS FETCH NEXT ' + CAST(@LastRec AS NVARCHAR(10)) + ' ROWS ONLY '
		END
	EXEC (@Sql) 		
END
